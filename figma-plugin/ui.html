<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --green: #22c55e; --red: #ef4444; --blue: #3b82f6;
      --bg: #fafafa; --surface: #fff; --border: #e5e7eb;
      --text: #111827; --muted: #6b7280;
      --mono: 'SF Mono', 'Fira Code', Monaco, Consolas, monospace;
    }
    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 12px; color: var(--text); background: var(--bg);
      padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
    }

    /* ── Header ── */
    .header { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px 8px; border-bottom: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
    .header-left { display: flex; align-items: center; gap: 6px; }
    .header-title { font-size: 13px; font-weight: 600; }
    .header-badge { font-size: 9px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; background: #f3f4f6; color: var(--muted); padding: 2px 6px; border-radius: 4px; }

    /* ── Status bar ── */
    .status-bar { display: flex; align-items: center; gap: 7px; padding: 7px 12px; font-size: 11px; font-weight: 500; border-bottom: 1px solid var(--border); flex-shrink: 0; transition: background 0.2s; }
    .status-bar.connected  { background: #f0fdf4; color: #15803d; }
    .status-bar.connecting { background: #eff6ff; color: #1d4ed8; }
    .status-bar.error      { background: #fef2f2; color: #b91c1c; }
    .dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .dot.green { background: var(--green); }
    .dot.blue  { background: var(--blue); animation: pulse 1.2s infinite; }
    .dot.red   { background: var(--red); }
    @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(.85)} }

    /* ── Content ── */
    .content { flex: 1; overflow-y: auto; padding: 10px 12px; display: flex; flex-direction: column; gap: 8px; }

    /* ── Setup card ── */
    .setup-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
    .setup-card-title { font-weight: 600; font-size: 12px; margin-bottom: 8px; }
    .setup-steps { display: flex; flex-direction: column; gap: 7px; }
    .step { display: flex; gap: 8px; align-items: flex-start; }
    .step-num { width: 18px; height: 18px; border-radius: 50%; background: #f3f4f6; border: 1px solid var(--border); font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
    .step-text { color: var(--text); line-height: 1.5; font-size: 11px; }
    .step-text strong { font-weight: 600; }
    .cmd { display: block; margin-top: 3px; font-family: var(--mono); font-size: 10px; background: #1e1e2e; color: #cdd6f4; padding: 4px 8px; border-radius: 4px; cursor: pointer; user-select: all; position: relative; }
    .cmd:hover::after { content: 'click to copy'; position: absolute; right: 6px; top: 50%; transform: translateY(-50%); font-size: 9px; color: #89b4fa; }

    /* ── Selection card ── */
    .selection-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; }
    .card-label { font-size: 9px; font-weight: 600; letter-spacing: 0.07em; text-transform: uppercase; color: var(--muted); margin-bottom: 3px; }
    .card-value { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-sub { font-family: var(--mono); font-size: 10px; color: var(--muted); margin-top: 2px; }
    .card-row { display: flex; gap: 6px; margin-top: 4px; }
    .pill { font-size: 10px; font-weight: 500; padding: 2px 7px; border-radius: 100px; background: #f3f4f6; color: var(--muted); }

    /* ── Multi-select ── */
    .multi-warn { background: #fffbeb; border: 1px solid #fde68a; border-radius: 8px; padding: 8px 10px; font-size: 11px; color: #92400e; }

    /* ── Empty state ── */
    .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; padding: 20px 12px; text-align: center; color: var(--muted); }
    .empty-icon { font-size: 28px; line-height: 1; }
    .empty-title { font-weight: 600; font-size: 12px; color: var(--text); }
    .empty-sub { font-size: 11px; line-height: 1.5; }

    /* ── Log ── */
    .log { flex-shrink: 0; max-height: 80px; overflow-y: auto; font-family: var(--mono); font-size: 10px; background: #1e1e2e; color: #cdd6f4; padding: 5px 10px; }
    .log-entry { margin-bottom: 1px; line-height: 1.4; }
    .log-entry .t   { color: #585b70; }
    .log-entry .ok  { color: #a6e3a1; }
    .log-entry .err { color: #f38ba8; }
    .log-entry .inf { color: #89b4fa; }

    /* ── Actions ── */
    .actions { display: flex; gap: 6px; padding: 8px 12px; border-top: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
    .btn { flex: 1; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; background: #fff; color: var(--text); font-size: 11px; font-weight: 500; cursor: pointer; transition: background .15s; text-align: center; }
    .btn:hover { background: #f3f4f6; border-color: #d1d5db; }
    .btn.primary { background: #111827; color: #fff; border-color: #111827; }
    .btn.primary:hover { background: #374151; }

    /* ── Settings ── */
    .settings { padding: 6px 12px 10px; border-top: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
    .settings-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.07em; color: var(--muted); margin-bottom: 4px; }
    .settings-row { display: flex; gap: 4px; }
    .settings-row input { flex: 1; padding: 5px 8px; border: 1px solid var(--border); border-radius: 5px; font-size: 11px; font-family: var(--mono); color: var(--text); background: #fff; outline: none; }
    .settings-row input:focus { border-color: var(--blue); }
    .settings-row .btn { flex: none; padding: 5px 10px; }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-left">
      <span>&#x1F517;</span>
      <span class="header-title">Selection Bridge</span>
      <span class="header-badge">MCP</span>
    </div>
    <span id="syncCount" style="font-size:10px;color:var(--muted)">0 syncs</span>
  </div>

  <div id="statusBar" class="status-bar connecting">
    <span class="dot blue" id="statusDot"></span>
    <span id="statusText">Checking server&#x2026;</span>
  </div>

  <div class="content">

    <!-- Shown when bridge is not running -->
    <div id="setupCard" class="setup-card" style="display:none">
      <div class="setup-card-title">&#x26A0;&#xFE0F; Bridge server not running</div>
      <div class="setup-steps">
        <div class="step">
          <div class="step-num">1</div>
          <div class="step-text">
            <strong>Open a terminal</strong> in your MCP Server project folder and run:
            <span class="cmd" id="cmdBridge">npm run bridge</span>
          </div>
        </div>
        <div class="step">
          <div class="step-num">2</div>
          <div class="step-text">Wait for <strong>"[Figma Bridge] Listening on 127.0.0.1:3050"</strong></div>
        </div>
        <div class="step">
          <div class="step-num">3</div>
          <div class="step-text">Click <strong>&#x21BB; Refresh</strong> below &mdash; or wait, it retries every 5&nbsp;s</div>
        </div>
      </div>
    </div>

    <!-- Shown when server OK, no selection yet -->
    <div id="emptyState" class="empty" style="display:none">
      <div class="empty-icon">&#x1F446;</div>
      <div class="empty-title">Click any node in Figma</div>
      <div class="empty-sub">Your selection will appear here<br>and become available to GitHub Copilot</div>
    </div>

    <!-- Active selection -->
    <div id="selectionInfo" style="display:none">
      <div class="selection-card">
        <div class="card-label">Selected Node</div>
        <div class="card-value" id="nodeName">&mdash;</div>
        <div class="card-sub" id="nodeSubtitle">&mdash;</div>
        <div class="card-row" id="nodePills"></div>
      </div>
      <div class="selection-card" style="margin-top:6px">
        <div class="card-label">File &middot; Page</div>
        <div class="card-sub" id="fileInfo">&mdash;</div>
      </div>
    </div>

    <!-- Multiple nodes selected -->
    <div id="multiWarn" class="multi-warn" style="display:none"></div>

  </div>

  <!-- Mini log -->
  <div class="log" id="log"></div>

  <div class="actions">
    <button class="btn primary" id="refreshBtn">&#x21BB; Refresh</button>
    <button class="btn" id="clearBtn">&#x2715; Clear</button>
  </div>

  <div class="settings">
    <div class="settings-label">Bridge Server URL</div>
    <div class="settings-row">
      <input type="text" id="serverUrl" value="http://localhost:3050" spellcheck="false" />
      <button class="btn" id="pingBtn">Ping</button>
    </div>
  </div>

  <script>
    var serverUrl = 'http://localhost:3050';
    var userId = 'anonymous';
    var syncCount = 0;
    var pingTimer = null;

    var statusBar      = document.getElementById('statusBar');
    var statusDot      = document.getElementById('statusDot');
    var statusText     = document.getElementById('statusText');
    var syncCountEl    = document.getElementById('syncCount');
    var setupCard      = document.getElementById('setupCard');
    var emptyState     = document.getElementById('emptyState');
    var selectionInfo  = document.getElementById('selectionInfo');
    var multiWarn      = document.getElementById('multiWarn');
    var nodeName       = document.getElementById('nodeName');
    var nodeSubtitle   = document.getElementById('nodeSubtitle');
    var nodePills      = document.getElementById('nodePills');
    var fileInfo       = document.getElementById('fileInfo');
    var logEl          = document.getElementById('log');
    var serverUrlInput = document.getElementById('serverUrl');

    function addLog(msg, type) {
      type = type || 'ok';
      var t = new Date().toLocaleTimeString('en-US', { hour12: false });
      var el = document.createElement('div');
      el.className = 'log-entry';
      el.innerHTML = '<span class="t">' + t + '</span> <span class="' + type + '">' + msg + '</span>';
      logEl.prepend(el);
      while (logEl.children.length > 60) logEl.removeChild(logEl.lastChild);
    }

    function setStatus(state, text) {
      var cls = state === 'ok' ? 'connected' : state === 'retry' ? 'connecting' : 'error';
      var dot = state === 'ok' ? 'green' : state === 'retry' ? 'blue' : 'red';
      statusBar.className = 'status-bar ' + cls;
      statusDot.className = 'dot ' + dot;
      statusText.textContent = text;
    }

    function checkServer() {
      return fetch(serverUrl + '/health', { signal: AbortSignal.timeout(2500) })
        .then(function(res) {
          if (res.ok) {
            setStatus('ok', 'Connected');
            setupCard.style.display = 'none';
            if (selectionInfo.style.display === 'none' && multiWarn.style.display === 'none') {
              emptyState.style.display = 'flex';
            }
            addLog('Server reachable', 'inf');
            return true;
          }
          throw new Error('HTTP ' + res.status);
        })
        .catch(function() {
          setStatus('error', 'Server unreachable \u2014 run: npm run bridge');
          setupCard.style.display = 'block';
          emptyState.style.display = 'none';
          selectionInfo.style.display = 'none';
          addLog('Server unreachable \u2014 run: npm run bridge', 'err');
          return false;
        });
    }

    function startPingLoop() {
      if (pingTimer) clearInterval(pingTimer);
      pingTimer = setInterval(function() {
        checkServer().then(function(ok) {
          if (ok) { clearInterval(pingTimer); pingTimer = null; }
        });
      }, 5000);
    }

    function pushSelection(payload) {
      setStatus('retry', 'Syncing\u2026');
      return fetch(serverUrl + '/selection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fileId: payload.fileId, nodeId: payload.nodeId, pageId: payload.pageId, userId: payload.userId, metadata: payload.metadata, designTree: payload.designTree })
      }).then(function(res) {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        syncCount++;
        syncCountEl.textContent = syncCount + ' sync' + (syncCount !== 1 ? 's' : '');
        var label = (payload.metadata && payload.metadata.nodeName) ? payload.metadata.nodeName : payload.nodeId;
        setStatus('ok', 'Connected \u00b7 ' + label);
        addLog('\u2713 Synced: ' + label);
      }).catch(function(err) {
        setStatus('error', 'Server unreachable');
        setupCard.style.display = 'block';
        addLog('\u2717 Push failed: ' + err.message, 'err');
        startPingLoop();
      });
    }

    function showSelection(data) {
      setupCard.style.display = 'none';
      emptyState.style.display = 'none';
      multiWarn.style.display = 'none';
      selectionInfo.style.display = 'block';
      nodeName.textContent = (data.metadata && data.metadata.nodeName) ? data.metadata.nodeName : data.nodeId;
      nodeSubtitle.textContent = data.nodeId;
      nodePills.innerHTML = '';
      if (data.metadata && data.metadata.nodeType) {
        var p1 = document.createElement('span'); p1.className = 'pill'; p1.textContent = data.metadata.nodeType; nodePills.appendChild(p1);
      }
      if (data.metadata && data.metadata.width && data.metadata.height) {
        var p2 = document.createElement('span'); p2.className = 'pill';
        p2.textContent = Math.round(data.metadata.width) + '\u00d7' + Math.round(data.metadata.height);
        nodePills.appendChild(p2);
      }
      fileInfo.textContent = data.fileId + ' / ' + (data.pageId || '\u2014');
    }

    window.onmessage = function(event) {
      var msg = event.data && event.data.pluginMessage;
      if (!msg) return;
      if (msg.type === 'init') {
        serverUrl = msg.serverUrl || serverUrl;
        userId = msg.userId || 'anonymous';
        serverUrlInput.value = serverUrl;
        addLog('Plugin ready \u00b7 ' + (msg.userName || userId), 'inf');
        checkServer().then(function(ok) { if (!ok) startPingLoop(); });
      } else if (msg.type === 'selection-changed') {
        showSelection(msg);
        pushSelection(msg);
      } else if (msg.type === 'selection-cleared') {
        emptyState.style.display = 'flex';
        selectionInfo.style.display = 'none';
        multiWarn.style.display = 'none';
        addLog('Selection cleared');
      } else if (msg.type === 'multi-selection') {
        setupCard.style.display = 'none';
        emptyState.style.display = 'none';
        selectionInfo.style.display = 'none';
        multiWarn.style.display = 'block';
        var names = msg.nodes.slice(0, 4).map(function(n) { return n.name + ' (' + n.type + ')'; }).join(', ');
        multiWarn.innerHTML = '\u26a0 <strong>' + msg.count + ' nodes selected</strong> \u2014 select a single node.<br>'
          + '<span style="color:var(--muted);font-family:var(--mono);font-size:10px;">' + names
          + (msg.count > 4 ? ' +' + (msg.count - 4) + ' more' : '') + '</span>';
        addLog('Multi-select: ' + msg.count + ' nodes', 'err');
      }
    };

    document.getElementById('refreshBtn').addEventListener('click', function() {
      parent.postMessage({ pluginMessage: { type: 'refresh' } }, '*');
      addLog('Manual refresh', 'inf');
      checkServer().then(function(ok) { if (!ok) startPingLoop(); });
    });

    document.getElementById('clearBtn').addEventListener('click', function() {
      fetch(serverUrl + '/selection', { method: 'DELETE' })
        .then(function() { emptyState.style.display = 'flex'; selectionInfo.style.display = 'none'; addLog('Cleared'); })
        .catch(function(err) { addLog('Clear failed: ' + err.message, 'err'); });
    });

    document.getElementById('pingBtn').addEventListener('click', function() {
      serverUrl = serverUrlInput.value.trim().replace(/\/$/, '');
      checkServer().then(function(ok) { if (!ok) startPingLoop(); });
    });

    serverUrlInput.addEventListener('change', function(e) {
      serverUrl = e.target.value.trim().replace(/\/$/, '');
    });

    document.getElementById('cmdBridge').addEventListener('click', function(e) {
      var text = e.target.textContent.trim();
      if (navigator.clipboard) { navigator.clipboard.writeText(text).then(function() { addLog('Copied: ' + text, 'inf'); }); }
    });
  </script>
</body>
</html>
